{
  "id": "flux-refine-4x-upscale-face-identity-v1",
  "revision": 0,
  "last_node_id": 45,
  "last_link_id": 85,
  "nodes": [
    {
      "id": 1,
      "type": "LoadImage",
      "pos": [-800, 0],
      "size": [315, 315],
      "flags": {},
      "order": 0,
      "mode": 0,
      "inputs": [],
      "outputs": [
        {
          "name": "IMAGE",
          "type": "IMAGE",
          "links": [1, 2, 3],
          "slot_index": 0
        },
        {
          "name": "MASK",
          "type": "MASK",
          "links": null
        }
      ],
      "title": "1 | Load Flux Dev Source Image (1024x1024)",
      "properties": {
        "Node name for S&R": "LoadImage"
      },
      "widgets_values": ["example.png", "image"],
      "color": "#666"
    },
    {
      "id": 2,
      "type": "CheckpointLoaderSimple",
      "pos": [-800, 400],
      "size": [315, 98],
      "flags": {},
      "order": 1,
      "mode": 0,
      "inputs": [],
      "outputs": [
        {
          "name": "MODEL",
          "type": "MODEL",
          "links": [5, 6],
          "slot_index": 0
        },
        {
          "name": "CLIP",
          "type": "CLIP",
          "links": [7, 8],
          "slot_index": 1
        },
        {
          "name": "VAE",
          "type": "VAE",
          "links": [9, 10],
          "slot_index": 2
        }
      ],
      "title": "2 | Load CyberRealisticXL Checkpoint",
      "properties": {
        "Node name for S&R": "CheckpointLoaderSimple"
      },
      "widgets_values": ["cyberrealisticXL_v70_fp32.safetensors"],
      "color": "#369"
    },
    {
      "id": 3,
      "type": "PulidModelLoader",
      "pos": [-400, 0],
      "size": [315, 58],
      "flags": {},
      "order": 2,
      "mode": 0,
      "inputs": [],
      "outputs": [
        {
          "name": "PULID",
          "type": "PULID",
          "links": [11],
          "slot_index": 0
        }
      ],
      "title": "3 | Load PuLID Model",
      "properties": {
        "Node name for S&R": "PulidModelLoader"
      },
      "widgets_values": ["pulid_v1.1.safetensors"],
      "color": "#322",
      "bgcolor": "#533"
    },
    {
      "id": 4,
      "type": "PulidInsightFaceLoader",
      "pos": [-400, 100],
      "size": [315, 58],
      "flags": {},
      "order": 3,
      "mode": 0,
      "inputs": [],
      "outputs": [
        {
          "name": "FACEANALYSIS",
          "type": "FACEANALYSIS",
          "links": [12],
          "slot_index": 0
        }
      ],
      "title": "4 | Load InsightFace for PuLID",
      "properties": {
        "Node name for S&R": "PulidInsightFaceLoader"
      },
      "widgets_values": ["CPU"],
      "color": "#322",
      "bgcolor": "#533"
    },
    {
      "id": 5,
      "type": "PulidEvaClipLoader",
      "pos": [-400, 200],
      "size": [315, 58],
      "flags": {},
      "order": 4,
      "mode": 0,
      "inputs": [],
      "outputs": [
        {
          "name": "EVA_CLIP",
          "type": "EVA_CLIP",
          "links": [13],
          "slot_index": 0
        }
      ],
      "title": "5 | Load EVA CLIP for PuLID",
      "properties": {
        "Node name for S&R": "PulidEvaClipLoader"
      },
      "widgets_values": [],
      "color": "#322",
      "bgcolor": "#533"
    },
    {
      "id": 6,
      "type": "ApplyPulid",
      "pos": [-400, 300],
      "size": [315, 266],
      "flags": {},
      "order": 10,
      "mode": 0,
      "inputs": [
        {
          "name": "model",
          "type": "MODEL",
          "link": 5
        },
        {
          "name": "pulid",
          "type": "PULID",
          "link": 11
        },
        {
          "name": "eva_clip",
          "type": "EVA_CLIP",
          "link": 13
        },
        {
          "name": "face_analysis",
          "type": "FACEANALYSIS",
          "link": 12
        },
        {
          "name": "image",
          "type": "IMAGE",
          "link": 1
        }
      ],
      "outputs": [
        {
          "name": "MODEL",
          "type": "MODEL",
          "links": [14],
          "slot_index": 0
        }
      ],
      "title": "6 | Apply PuLID (ENABLED - Disable for IPAdapter)",
      "properties": {
        "Node name for S&R": "ApplyPulid"
      },
      "widgets_values": ["fidelity", 0.8, 0.0, 1.0],
      "color": "#322",
      "bgcolor": "#533"
    },
    {
      "id": 7,
      "type": "IPAdapterUnifiedLoaderFaceID",
      "pos": [-400, 650],
      "size": [315, 78],
      "flags": {},
      "order": 11,
      "mode": 4,
      "inputs": [
        {
          "name": "model",
          "type": "MODEL",
          "link": 6
        }
      ],
      "outputs": [
        {
          "name": "MODEL",
          "type": "MODEL",
          "links": [15],
          "slot_index": 0
        },
        {
          "name": "ipadapter",
          "type": "IPADAPTER",
          "links": [16],
          "slot_index": 1
        }
      ],
      "title": "7 | IPAdapter FaceID Loader (DISABLED - Enable if not using PuLID)",
      "properties": {
        "Node name for S&R": "IPAdapterUnifiedLoaderFaceID"
      },
      "widgets_values": ["FACEID PLUS V2", 0.6, "CPU"],
      "color": "#432",
      "bgcolor": "#653"
    },
    {
      "id": 8,
      "type": "IPAdapterFaceID",
      "pos": [-400, 800],
      "size": [315, 418],
      "flags": {},
      "order": 12,
      "mode": 4,
      "inputs": [
        {
          "name": "model",
          "type": "MODEL",
          "link": 15
        },
        {
          "name": "ipadapter",
          "type": "IPADAPTER",
          "link": 16
        },
        {
          "name": "image",
          "type": "IMAGE",
          "link": 2
        }
      ],
      "outputs": [
        {
          "name": "MODEL",
          "type": "MODEL",
          "links": [17],
          "slot_index": 0
        },
        {
          "name": "face_image",
          "type": "IMAGE",
          "links": null
        }
      ],
      "title": "8 | Apply IPAdapter FaceID (DISABLED - Enable if not using PuLID)",
      "properties": {
        "Node name for S&R": "IPAdapterFaceID"
      },
      "widgets_values": [1.0, 1.0, "linear", "concat", 0.0, 1.0, "V only"],
      "color": "#432",
      "bgcolor": "#653"
    },
    {
      "id": 9,
      "type": "CLIPTextEncode",
      "pos": [50, 0],
      "size": [400, 200],
      "flags": {},
      "order": 13,
      "mode": 0,
      "inputs": [
        {
          "name": "clip",
          "type": "CLIP",
          "link": 7
        }
      ],
      "outputs": [
        {
          "name": "CONDITIONING",
          "type": "CONDITIONING",
          "links": [18, 19],
          "slot_index": 0
        }
      ],
      "title": "9 | Positive Prompt - Skin Detail Enhancement",
      "properties": {
        "Node name for S&R": "CLIPTextEncode"
      },
      "widgets_values": ["masterpiece, best quality, photorealistic, ultra high resolution, 8k uhd, professional photography, natural skin texture, visible pores, skin detail, subtle skin imperfections, realistic skin, individual pore detail, facial detail, natural skin moisture, dewy skin, moist lips, glossy lips, detailed hair strands, individual hair texture, refined fabric texture, sharp focus, enhanced clarity, same person, consistent identity, facial consistency, preserved features"],
      "color": "#232",
      "bgcolor": "#353"
    },
    {
      "id": 10,
      "type": "CLIPTextEncode",
      "pos": [50, 250],
      "size": [400, 200],
      "flags": {},
      "order": 14,
      "mode": 0,
      "inputs": [
        {
          "name": "clip",
          "type": "CLIP",
          "link": 8
        }
      ],
      "outputs": [
        {
          "name": "CONDITIONING",
          "type": "CONDITIONING",
          "links": [20, 21],
          "slot_index": 0
        }
      ],
      "title": "10 | Negative Prompt - Avoid Smoothing",
      "properties": {
        "Node name for S&R": "CLIPTextEncode"
      },
      "widgets_values": ["smooth skin, airbrushed, perfect skin, beauty filter, poreless, polished skin, flat skin, plastic skin, featureless skin, simplified skin, lack of skin detail, dry lips, matte lips, flat lips, chalky lips, dull lips, dry skin, matte skin, blurry, low quality, worst quality, low resolution, blurry hair, soft hair, merged hair strands, filtered, over-processed, smoothed detail"],
      "color": "#322",
      "bgcolor": "#533"
    },
    {
      "id": 11,
      "type": "VAEEncode",
      "pos": [50, 500],
      "size": [210, 46],
      "flags": {},
      "order": 15,
      "mode": 0,
      "inputs": [
        {
          "name": "pixels",
          "type": "IMAGE",
          "link": 3
        },
        {
          "name": "vae",
          "type": "VAE",
          "link": 9
        }
      ],
      "outputs": [
        {
          "name": "LATENT",
          "type": "LATENT",
          "links": [22],
          "slot_index": 0
        }
      ],
      "title": "11 | Encode Source Image",
      "properties": {
        "Node name for S&R": "VAEEncode"
      },
      "widgets_values": []
    },
    {
      "id": 12,
      "type": "KSampler",
      "pos": [500, 0],
      "size": [315, 262],
      "flags": {},
      "order": 16,
      "mode": 0,
      "inputs": [
        {
          "name": "model",
          "type": "MODEL",
          "link": 14
        },
        {
          "name": "positive",
          "type": "CONDITIONING",
          "link": 18
        },
        {
          "name": "negative",
          "type": "CONDITIONING",
          "link": 20
        },
        {
          "name": "latent_image",
          "type": "LATENT",
          "link": 22
        }
      ],
      "outputs": [
        {
          "name": "LATENT",
          "type": "LATENT",
          "links": [23],
          "slot_index": 0
        }
      ],
      "title": "12 | First Pass - Refine & Add Initial Detail",
      "properties": {
        "Node name for S&R": "KSampler"
      },
      "widgets_values": [
        123456789,
        "randomize",
        25,
        4.5,
        "dpmpp_2m_sde",
        "karras",
        0.45
      ],
      "color": "#393"
    },
    {
      "id": 13,
      "type": "VAEDecode",
      "pos": [850, 0],
      "size": [210, 46],
      "flags": {},
      "order": 17,
      "mode": 0,
      "inputs": [
        {
          "name": "samples",
          "type": "LATENT",
          "link": 23
        },
        {
          "name": "vae",
          "type": "VAE",
          "link": 10
        }
      ],
      "outputs": [
        {
          "name": "IMAGE",
          "type": "IMAGE",
          "links": [24, 25],
          "slot_index": 0
        }
      ],
      "title": "13 | Decode Refined Image",
      "properties": {
        "Node name for S&R": "VAEDecode"
      },
      "widgets_values": []
    },
    {
      "id": 14,
      "type": "PreviewImage",
      "pos": [1100, 0],
      "size": [500, 400],
      "flags": {},
      "order": 18,
      "mode": 0,
      "inputs": [
        {
          "name": "images",
          "type": "IMAGE",
          "link": 24
        }
      ],
      "outputs": [],
      "title": "14 | Preview First Pass Result",
      "properties": {
        "Node name for S&R": "PreviewImage"
      },
      "widgets_values": []
    },
    {
      "id": 15,
      "type": "UpscaleModelLoader",
      "pos": [850, 100],
      "size": [315, 58],
      "flags": {},
      "order": 5,
      "mode": 0,
      "inputs": [],
      "outputs": [
        {
          "name": "UPSCALE_MODEL",
          "type": "UPSCALE_MODEL",
          "links": [26],
          "slot_index": 0
        }
      ],
      "title": "15 | Load 4x Upscale Model",
      "properties": {
        "Node name for S&R": "UpscaleModelLoader"
      },
      "widgets_values": ["4x-UltraSharp.pth"],
      "color": "#232",
      "bgcolor": "#353"
    },
    {
      "id": 16,
      "type": "ImageUpscaleWithModel",
      "pos": [850, 200],
      "size": [315, 46],
      "flags": {},
      "order": 19,
      "mode": 0,
      "inputs": [
        {
          "name": "upscale_model",
          "type": "UPSCALE_MODEL",
          "link": 26
        },
        {
          "name": "image",
          "type": "IMAGE",
          "link": 25
        }
      ],
      "outputs": [
        {
          "name": "IMAGE",
          "type": "IMAGE",
          "links": [27, 28],
          "slot_index": 0
        }
      ],
      "title": "16 | 4x Upscale (1024 → 4096)",
      "properties": {
        "Node name for S&R": "ImageUpscaleWithModel"
      },
      "widgets_values": []
    },
    {
      "id": 17,
      "type": "ControlNetLoader",
      "pos": [850, 300],
      "size": [315, 58],
      "flags": {},
      "order": 6,
      "mode": 0,
      "inputs": [],
      "outputs": [
        {
          "name": "CONTROL_NET",
          "type": "CONTROL_NET",
          "links": [29],
          "slot_index": 0
        }
      ],
      "title": "17 | Load ControlNet Tile",
      "properties": {
        "Node name for S&R": "ControlNetLoader"
      },
      "widgets_values": ["SDXL/TTPLANET_Controlnet_Tile_realistic_v2_fp16.safetensors"],
      "color": "#2a363b",
      "bgcolor": "#3f5159"
    },
    {
      "id": 18,
      "type": "ControlNetApplyAdvanced",
      "pos": [850, 400],
      "size": [315, 186],
      "flags": {},
      "order": 20,
      "mode": 0,
      "inputs": [
        {
          "name": "positive",
          "type": "CONDITIONING",
          "link": 19
        },
        {
          "name": "negative",
          "type": "CONDITIONING",
          "link": 21
        },
        {
          "name": "control_net",
          "type": "CONTROL_NET",
          "link": 29
        },
        {
          "name": "image",
          "type": "IMAGE",
          "link": 27
        }
      ],
      "outputs": [
        {
          "name": "positive",
          "type": "CONDITIONING",
          "links": [30],
          "slot_index": 0
        },
        {
          "name": "negative",
          "type": "CONDITIONING",
          "links": [31],
          "slot_index": 1
        }
      ],
      "title": "18 | Apply ControlNet Tile (Prevent Hallucinations)",
      "properties": {
        "Node name for S&R": "ControlNetApplyAdvanced"
      },
      "widgets_values": [0.75, 0.0, 1.0],
      "color": "#2a363b",
      "bgcolor": "#3f5159"
    },
    {
      "id": 19,
      "type": "VAEEncodeTiled",
      "pos": [1200, 400],
      "size": [270, 150],
      "flags": {},
      "order": 21,
      "mode": 0,
      "inputs": [
        {
          "name": "pixels",
          "type": "IMAGE",
          "link": 28
        },
        {
          "name": "vae",
          "type": "VAE",
          "link": 32
        }
      ],
      "outputs": [
        {
          "name": "LATENT",
          "type": "LATENT",
          "links": [33],
          "slot_index": 0
        }
      ],
      "title": "19 | Encode Upscaled (Tiled)",
      "properties": {
        "Node name for S&R": "VAEEncodeTiled"
      },
      "widgets_values": [1024, 128, 64, 8]
    },
    {
      "id": 20,
      "type": "CheckpointLoaderSimple",
      "pos": [-800, 550],
      "size": [315, 98],
      "flags": {},
      "order": 7,
      "mode": 0,
      "inputs": [],
      "outputs": [
        {
          "name": "MODEL",
          "type": "MODEL",
          "links": [34],
          "slot_index": 0
        },
        {
          "name": "CLIP",
          "type": "CLIP",
          "links": null
        },
        {
          "name": "VAE",
          "type": "VAE",
          "links": [32, 35],
          "slot_index": 2
        }
      ],
      "title": "20 | Reload Model for Second Pass (Clean)",
      "properties": {
        "Node name for S&R": "CheckpointLoaderSimple"
      },
      "widgets_values": ["cyberrealisticXL_v70_fp32.safetensors"],
      "color": "#369"
    },
    {
      "id": 21,
      "type": "KSampler",
      "pos": [1500, 400],
      "size": [315, 262],
      "flags": {},
      "order": 22,
      "mode": 0,
      "inputs": [
        {
          "name": "model",
          "type": "MODEL",
          "link": 34
        },
        {
          "name": "positive",
          "type": "CONDITIONING",
          "link": 30
        },
        {
          "name": "negative",
          "type": "CONDITIONING",
          "link": 31
        },
        {
          "name": "latent_image",
          "type": "LATENT",
          "link": 33
        }
      ],
      "outputs": [
        {
          "name": "LATENT",
          "type": "LATENT",
          "links": [36],
          "slot_index": 0
        }
      ],
      "title": "21 | Second Pass - Generate Missing Skin Detail (High Denoise)",
      "properties": {
        "Node name for S&R": "KSampler"
      },
      "widgets_values": [
        987654321,
        "randomize",
        35,
        4.0,
        "dpmpp_2m_sde",
        "karras",
        0.55
      ],
      "color": "#393"
    },
    {
      "id": 22,
      "type": "VAEDecodeTiled",
      "pos": [1850, 400],
      "size": [270, 150],
      "flags": {},
      "order": 23,
      "mode": 0,
      "inputs": [
        {
          "name": "samples",
          "type": "LATENT",
          "link": 36
        },
        {
          "name": "vae",
          "type": "VAE",
          "link": 35
        }
      ],
      "outputs": [
        {
          "name": "IMAGE",
          "type": "IMAGE",
          "links": [37],
          "slot_index": 0
        }
      ],
      "title": "22 | Decode Final (Tiled)",
      "properties": {
        "Node name for S&R": "VAEDecodeTiled"
      },
      "widgets_values": [1024, 128, 64, 8]
    },
    {
      "id": 23,
      "type": "SaveImage",
      "pos": [2150, 400],
      "size": [600, 550],
      "flags": {},
      "order": 24,
      "mode": 0,
      "inputs": [
        {
          "name": "images",
          "type": "IMAGE",
          "link": 37
        }
      ],
      "outputs": [],
      "title": "23 | Save Final 4K Image",
      "properties": {
        "Node name for S&R": "SaveImage"
      },
      "widgets_values": ["Flux_Refine_4x_FaceID"],
      "color": "#666"
    },
    {
      "id": 24,
      "type": "Note",
      "pos": [-800, -300],
      "size": [700, 250],
      "flags": {},
      "order": 8,
      "mode": 0,
      "inputs": [],
      "outputs": [],
      "title": "FLUX DEV REFINER & 4X UPSCALE WITH FACE IDENTITY",
      "properties": {},
      "widgets_values": [
        "PURPOSE: Refine Flux Dev 1024x1024 images and upscale to 4K with realistic skin detail\n\nFACE IDENTITY OPTIONS:\n• PuLID (ENABLED): Nodes 3-6. Best for photorealism and fidelity mode\n• IP Adapter FaceID (DISABLED): Nodes 7-8. Alternative option - enable if PuLID issues\n  → To switch: Set node 6 to mode=4 (disable) and nodes 7-8 to mode=0 (enable)\n\nWORKFLOW:\n1. Load 1024x1024 Flux Dev image\n2. First Pass: Refine with face identity (denoise 0.45)\n3. 4x Upscale: 1024 → 4096 using 4x-UltraSharp\n4. Second Pass: ControlNet Tile + high denoise (0.55) to generate missing skin detail\n\nREQUIREMENTS:\n• CyberRealisticXL checkpoint\n• PuLID models OR IPAdapter FaceID models\n• ControlNet Tile: TTPLANET_Controlnet_Tile_realistic_v2_fp16.safetensors\n• 4x-UltraSharp.pth upscale model\n\nKEY SETTINGS:\n• ControlNet Tile Strength: 0.75 (prevents hallucinations at high denoise)\n• Second Pass Denoise: 0.55 (generates detail without losing identity)\n• Tiled VAE: 1024px tiles for 4K processing"
      ],
      "color": "#432",
      "bgcolor": "#653"
    },
    {
      "id": 25,
      "type": "Note",
      "pos": [-400, 1270],
      "size": [520, 180],
      "flags": {},
      "order": 9,
      "mode": 0,
      "inputs": [],
      "outputs": [],
      "title": "PuLID vs IP Adapter FaceID - Which to Use?",
      "properties": {},
      "widgets_values": [
        "PULID (Nodes 3-6) - ENABLED BY DEFAULT:\n✓ Better for photorealism and maintaining exact facial features\n✓ 'fidelity' mode preserves identity strongly\n✓ Weight 0.8 recommended for skin detail workflows\n✓ Requires: pulid_v1.1.safetensors in ComfyUI/models/pulid/\n\nIP ADAPTER FACEID (Nodes 7-8) - DISABLED BY DEFAULT:\n✓ More artistic flexibility with weight curves\n✓ FaceID Plus V2 offers good detail preservation\n✓ Can combine multiple face embeddings\n✓ Requires: IP-Adapter-FaceID models in ComfyUI/models/ipadapter/\n\nTO SWITCH: Disable one branch (mode=4) and enable the other (mode=0)\nDO NOT enable both simultaneously - they will conflict!"
      ],
      "color": "#322",
      "bgcolor": "#533"
    }
  ],
  "links": [
    [1, 1, 0, 6, 4, "IMAGE"],
    [2, 1, 0, 8, 2, "IMAGE"],
    [3, 1, 0, 11, 0, "IMAGE"],
    [5, 2, 0, 6, 0, "MODEL"],
    [6, 2, 0, 7, 0, "MODEL"],
    [7, 2, 1, 9, 0, "CLIP"],
    [8, 2, 1, 10, 0, "CLIP"],
    [9, 2, 2, 11, 1, "VAE"],
    [10, 2, 2, 13, 1, "VAE"],
    [11, 3, 0, 6, 1, "PULID"],
    [12, 4, 0, 6, 3, "FACEANALYSIS"],
    [13, 5, 0, 6, 2, "EVA_CLIP"],
    [14, 6, 0, 12, 0, "MODEL"],
    [15, 7, 0, 8, 0, "MODEL"],
    [16, 7, 1, 8, 1, "IPADAPTER"],
    [17, 8, 0, 12, 0, "MODEL"],
    [18, 9, 0, 12, 1, "CONDITIONING"],
    [19, 9, 0, 18, 0, "CONDITIONING"],
    [20, 10, 0, 12, 2, "CONDITIONING"],
    [21, 10, 0, 18, 1, "CONDITIONING"],
    [22, 11, 0, 12, 3, "LATENT"],
    [23, 12, 0, 13, 0, "LATENT"],
    [24, 13, 0, 14, 0, "IMAGE"],
    [25, 13, 0, 16, 1, "IMAGE"],
    [26, 15, 0, 16, 0, "UPSCALE_MODEL"],
    [27, 16, 0, 18, 3, "IMAGE"],
    [28, 16, 0, 19, 0, "IMAGE"],
    [29, 17, 0, 18, 2, "CONTROL_NET"],
    [30, 18, 0, 21, 1, "CONDITIONING"],
    [31, 18, 1, 21, 2, "CONDITIONING"],
    [32, 20, 2, 19, 1, "VAE"],
    [33, 19, 0, 21, 3, "LATENT"],
    [34, 20, 0, 21, 0, "MODEL"],
    [35, 20, 2, 22, 1, "VAE"],
    [36, 21, 0, 22, 0, "LATENT"],
    [37, 22, 0, 23, 0, "IMAGE"]
  ],
  "groups": [],
  "config": {},
  "extra": {
    "ds": {
      "scale": 0.75,
      "offset": [900, 400]
    }
  },
  "version": 0.4
}
